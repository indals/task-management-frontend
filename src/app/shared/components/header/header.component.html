<!-- ðŸ”§ FIXED: Added dynamic classes for sidebar state -->
<header class="app-header" 
        [class.sidebar-collapsed]="sidebarCollapsed" 
        [class.sidebar-expanded]="!sidebarCollapsed">
  <div class="header-content">
    
    <!-- Left Section: Search -->
    <div class="header-left">
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-icon matPrefix>search</mat-icon>
          <input 
            matInput 
            placeholder="Search tasks, projects..." 
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()"
            (keyup.escape)="searchQuery = ''"
            maxlength="100"
            aria-label="Search">
          <button 
            mat-icon-button 
            matSuffix 
            *ngIf="searchQuery"
            (click)="searchQuery = ''; onSearch()"
            matTooltip="Clear search"
            aria-label="Clear search">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </div>

    <!-- Center Section: Greeting -->
    <div class="header-center">
      <div class="greeting" *ngIf="currentUser">
        <span class="greeting-text">{{ getGreeting() }}, {{ currentUser.name }}!</span>
        <small class="role-display">{{ getUserRoleDisplay() }}</small>
      </div>
    </div>

    <!-- Right Section: Actions & Profile -->
    <div class="header-right">
      
      <!-- Quick Actions -->
      <div class="quick-actions">
        <button 
          mat-icon-button 
          matTooltip="Create Task"
          (click)="createTask()"
          aria-label="Create Task">
          <mat-icon>add_task</mat-icon>
        </button>
        
        <button 
          mat-icon-button 
          matTooltip="Create Project"
          (click)="createProject()"
          aria-label="Create Project">
          <mat-icon>create_new_folder</mat-icon>
        </button>
      </div>

      <!-- Notifications -->
      <div class="notification-container">
        <button 
          mat-icon-button 
          class="notification-btn"
          [class.has-notifications]="unreadNotificationCount > 0"
          (click)="onNotificationClick()"
          matTooltip="Notifications ({{ unreadNotificationCount }})"
          aria-label="Notifications">
          <mat-icon>notifications</mat-icon>
          <span 
            class="notification-badge" 
            *ngIf="unreadNotificationCount > 0"
            [attr.aria-label]="unreadNotificationCount + ' unread notifications'">
            {{ unreadNotificationCount > 99 ? '99+' : unreadNotificationCount }}
          </span>
        </button>

        <!-- Enhanced Notification Panel -->
        <div 
          class="notification-panel" 
          *ngIf="showNotificationPanel"
          clickOutside
          (clickOutside)="closeNotificationPanel()"
          role="dialog"
          aria-label="Notifications">
          
          <div class="panel-header">
            <h3>Notifications</h3>
            <div class="header-actions">
              <button 
                mat-icon-button 
                (click)="markAllNotificationsAsRead()"
                matTooltip="Mark all as read"
                *ngIf="unreadNotificationCount > 0"
                aria-label="Mark all notifications as read">
                <mat-icon>done_all</mat-icon>
              </button>
              <button 
                mat-icon-button 
                (click)="closeNotificationPanel()"
                matTooltip="Close"
                aria-label="Close notifications">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <div class="panel-content">
            <!-- Loading State -->
            <div class="loading-state" *ngIf="isLoading">
              <mat-icon class="spinning">refresh</mat-icon>
              <p>Loading notifications...</p>
            </div>

            <!-- No Notifications -->
            <div class="no-notifications" *ngIf="!isLoading && unreadNotificationCount === 0">
              <mat-icon>notifications_none</mat-icon>
              <p>No new notifications</p>
              <small>You're all caught up!</small>
            </div>
            
            <!-- Notification List -->
            <div class="notification-list" *ngIf="!isLoading && notifications.length > 0">
              <div 
                class="notification-item"
                *ngFor="let notification of notifications; trackBy: trackByNotificationId"
                [class.unread]="!notification.read"
                (click)="onNotificationItemClick(notification)"
                (keydown)="onNotificationKeyDown($event, notification)"
                role="button"
                tabindex="0"
                [attr.aria-label]="notification.message">
                
                <div class="notification-icon">
                  <mat-icon [ngSwitch]="notification.type">
                    <ng-container *ngSwitchCase="'TASK_ASSIGNED'">assignment_ind</ng-container>
                    <ng-container *ngSwitchCase="'TASK_COMPLETED'">task_alt</ng-container>
                    <ng-container *ngSwitchCase="'COMMENT_ADDED'">comment</ng-container>
                    <ng-container *ngSwitchCase="'PROJECT_UPDATED'">folder</ng-container>
                    <ng-container *ngSwitchCase="'SPRINT_STARTED'">play_arrow</ng-container>
                    <ng-container *ngSwitchDefault>notifications</ng-container>
                  </mat-icon>
                </div>
                
                <div class="notification-content">
                  <p class="notification-title">{{ notification.title || 'Notification' }}</p>
                  <p class="notification-message">{{ notification.message }}</p>
                  <small class="notification-time">{{ notification.createdAt | date:'short' }}</small>
                </div>
                
                <div class="notification-status" *ngIf="!notification.read">
                  <div class="unread-dot"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel-footer">
            <button 
              mat-button 
              (click)="viewAllNotifications()"
              class="view-all-btn">
              View All Notifications
            </button>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <button 
        mat-icon-button 
        matTooltip="Settings"
        (click)="onSettingsClick()"
        aria-label="Settings">
        <mat-icon>settings</mat-icon>
      </button>

      <!-- Profile Menu -->
      <div class="profile-container">
        <button 
          mat-button 
          class="profile-btn"
          [matMenuTriggerFor]="profileMenu"
          aria-label="Profile menu">
          <div class="profile-avatar">
            <img 
              *ngIf="currentUser?.avatar_url; else avatarFallback" 
              [src]="currentUser?.avatar_url" 
              [alt]="(currentUser?.name || 'User') + ' avatar'"
              loading="lazy">
            <ng-template #avatarFallback>
              <div class="avatar-initials" [attr.aria-label]="currentUser?.name + ' initials'">
                {{ getUserInitials() }}
              </div>
            </ng-template>
          </div>
          <span class="profile-name" *ngIf="currentUser">{{ currentUser.name }}</span>
          <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
        </button>

        <mat-menu #profileMenu="matMenu" class="profile-menu">
          <!-- Profile Header in Menu -->
          <div class="profile-header" mat-menu-item disabled>
            <div class="profile-info">
              <div class="profile-name">{{ currentUser?.name }}</div>
              <div class="profile-email">{{ currentUser?.email }}</div>
              <div class="profile-role">{{ getUserRoleDisplay() }}</div>
            </div>
          </div>
          
          <mat-divider></mat-divider>
          
          <button mat-menu-item routerLink="/profile">
            <mat-icon>person</mat-icon>
            <span>My Profile</span>
          </button>
          
          <button mat-menu-item routerLink="/settings">
            <mat-icon>settings</mat-icon>
            <span>Settings</span>
          </button>
          
          <button mat-menu-item routerLink="/notifications">
            <mat-icon>notifications</mat-icon>
            <span>Notifications</span>
            <span class="menu-badge" *ngIf="unreadNotificationCount > 0">
              {{ unreadNotificationCount }}
            </span>
          </button>
          
          <mat-divider></mat-divider>
          
          <button mat-menu-item routerLink="/help">
            <mat-icon>help</mat-icon>
            <span>Help & Support</span>
          </button>
          
          <mat-divider></mat-divider>
          
          <button mat-menu-item (click)="onLogout()" class="logout-item">
            <mat-icon>logout</mat-icon>
            <span>Logout</span>
          </button>
        </mat-menu>
      </div>

    </div>
  </div>
</header>